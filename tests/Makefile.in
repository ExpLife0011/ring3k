#
# Makefile for regression tests
# Copyright 2007-2008 Mike McCormack
#

CC=@MINGW32CC@
STRIP=@MINGW32STRIP@
CFLAGS=-Wall -O2
AS=@MINGW32AS@
AR=@MINGW32AR@
RANLIB=@MINGW32RANLIB@
WINDRES=@MINGW32WINDRES@

TESTS = \
	atom.c \
	completion.c \
	event.c \
	eventpair.c \
	file.c \
	gdi.c \
	heap.c \
	job.c \
	mailslot.c \
	mutant.c \
	object.c \
	pipe.c \
	port.c \
	process.c \
	reg.c \
	section.c \
	seh.c \
	sema.c \
	syscall.c \
	thread.c \
	timer.c \
	token.c \
	virtual.c \
	wine-atom.c \
	wine-port.c

SOURCE = \
	$(TESTS) \
	hostnt.c \
	native.c \
	ps.c \
	qdf.c \
	runnt.c

ISO = nttests.iso

.%.d: %.c
	$(CC) -MM $< > $@

.PHONY: all clean

NTWIN32LIB=win2k/libntwin32.a

all: $(SOURCE:.c=.exe) $(ISO)

DEPFILES = $(SOURCE:%.c=.%.d)

include $(DEPFILES)

runtests.bat: Makefile
	echo @rem Generated by Makefile > $@
	for f in $(TESTS:%.c=%.exe); do echo @hostnt.exe $$f >> $@ ; done

# ntwin32.dll differs between windows versions
#win2k/ntwin32.dll win2k/libntwin32.a: win2k/ntwin32.o
#	$(CC) -o $@ -shared -nostartfiles -nodefaultlibs -Wl,--out-implib,win2k/libntwin32.a $<

win2k/libntwin32.a: win2k/ntwin32.o
	$(RM) $@
	$(AR) rv $@ $<
	$(RANLIB) $@

win2k/ntwin32.o: win2k/ntwin32.s
	$(AS) -o $@ $<

win2k/ntwin32.s: win2k/ntwin32.in gen_syscalls.pl
	perl gen_syscalls.pl $< > $@

#winxp/ntwin32.dll winxp/libntwin32.a: winxp/ntwin32.o
#	$(CC) -o $@ -shared -nostartfiles -nodefaultlibs -Wl,--out-implib,winxp/libntwin32.a $<

winxp/ntwin32.o: winxp/ntwin32.s
	$(AS) -o $@ $<

winxp/ntwin32.s: winxp/ntwin32.in gen_syscalls.pl
	perl gen_syscalls.pl $< > $@

dillo.exe: dillo.o
	$(CC) -o $@ $< -lntdll

runnt.exe: runnt.o
	$(CC) -o $@ $< -lntdll -lkernel32

hostnt.exe: hostnt.o
	$(CC) -o $@ $< -lntdll -lkernel32

dumphandles.exe: dumphandles.o $(NTWIN32LIB)
	$(CC) -o $@ $< $(NTWIN32LIB) -lntdll -lkernel32 -luser32

res.o: res.rc
	$(WINDRES) -o $@ $<

qdf.exe: qdf.o
	$(CC) -o $@ $< -luser32 -lkernel32 -lntdll -lgdi32

gdi.exe: gdi.o log.o $(NTWIN32LIB)
	$(CC) -o $@ log.o $< -lntdll $(NTWIN32LIB) -nostartfiles -nodefaultlibs -Wl,--subsystem=native -e _NtProcessStartup

atom.exe: atom.o log.o $(NTWIN32LIB)
	$(CC) -o $@ log.o $< -lntdll $(NTWIN32LIB) -nostartfiles -nodefaultlibs -Wl,--subsystem=native -e _NtProcessStartup

wine-atom.exe: wine-atom.o log.o $(NTWIN32LIB)
	$(CC) -o $@ log.o $< -lntdll $(NTWIN32LIB) -nostartfiles -nodefaultlibs -Wl,--subsystem=native -e _NtProcessStartup

%.exe: %.o log.o
	$(CC) -o $@ log.o $< -lntdll -nostartfiles -nodefaultlibs -Wl,--subsystem=native -e _NtProcessStartup

seh.s: seh.c
	i586-mingw32msvc-cc $(CFLAGS) -S seh.c

$(ISO): $(SOURCE:.c=.exe)
	genisoimage -r -J -input-charset utf-8 -o $(ISO) $(SOURCE:.c=.exe)

clean:
	$(RM) *.exe *.o *.s *.a *.bat *.dll
	$(RM) win2k/*.a win2k/*.s win2k/*.lib win2k/*.dll win2k/*.o
	$(RM) winxp/*.a winxp/*.s winxp/*.lib winxp/*.dll winxp/*.o
	$(RM) 
