#
# ring3k - a user mode kernel for windows executables
#
# Copyright 2006-2009 Mike McCormack
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation; either
# version 2.1 of the License, or (at your option) any later version.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
# 
# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA
#

srcdir = @srcdir@
VPATH  = @srcdir@

prefix = @prefix@
bindir = ${prefix}/bin

INSTALL = @INSTALL@
INSTALL_SCRIPT = @INSTALL_SCRIPT@

LAUNCH_SCRIPT = ring3k
SETUP_SCRIPT = ring3k-setup

RM = rm -f

DIRS = \
	libudis86_dir \
	libmspack_dir \
	kernel_dir \
	tests_dir \
	tools_dir \
	unpack_dir \
	winemine_dir

all: $(DIRS) $(LAUNCH_SCRIPT) $(SETUP_SCRIPT)

.PHONY: \
	$(DIRS)
	all \
	clean \
	distclean \
	test

$(LAUNCH_SCRIPT): ring3k.in
	cp -f $< $@

$(SETUP_SCRIPT): ring3k-setup.in
	cp -f $< $@

kernel_dir: libudis86_dir
	cd kernel && make

tests_dir:
	cd tests && make

tools_dir: tests_dir
	cd tools && make

libudis86_dir:
	cd libudis86 && make

libmspack_dir:
	cd libmspack && make

unpack_dir: libmspack_dir
	cd unpack && make

winemine_dir:
	cd winemine && make

stat:
	cd kernel && make stat

clean:
	$(RM) $(LAUNCH_SCRIPT) $(SETUP_SCRIPT)
	cd libudis86 && make clean
	cd libmspack && make clean
	cd kernel && make clean
	cd tests && make clean
	cd tools && make clean
	cd unpack && make clean
	cd winemine && make clean

distclean: clean
	rm -rf drive
	rm -rf config.status config.log autom4te.cache
	find . -name Makefile -exec rm {} \;

install: $(LAUNCH_SCRIPT) $(SETUP_SCRIPT)
	mkdir -p $(DESTDIR)$(bindir)
	$(INSTALL_SCRIPT) $(INSTALL_FLAGS) $(LAUNCH_SCRIPT) $(DESTDIR)$(bindir)
	$(INSTALL_SCRIPT) $(INSTALL_FLAGS) $(SETUP_SCRIPT) $(DESTDIR)$(bindir)
	cd kernel && make install
	cd tools && make install
	cd unpack && make install
	cd winemine && make install

uninstall:
	$(RM) $(DESTDIR)$(bindir)/$(LAUNCH_SCRIPT)
	$(RM) $(DESTDIR)$(bindir)/$(SETUP_SCRIPT)
	cd kernel && make uninstall

TESTLIST = \
	completion \
	device \
	event \
	file \
	font \
	gdi \
	heap \
	job \
	mailslot \
	mutant \
	object \
	port \
	process \
	reg \
	section \
	seh \
	sema \
	syscall \
	thread \
	timer \
	token \
	user \
	virtual \
	wine-port

test: all
	@echo "Thread tracing tests"
	for tc in $(TESTLIST) ; do echo $$tc ; ./runtest $$tc || exit 1 ; done

help:
	@echo "Available targets are:"
	@echo
	@echo " all        Build ring3k and tests (default)"
	@echo " clean      Clean temporary files and executables"
	@echo " distclean  Clean everything"
	@echo " install    Install"
	@echo " stat       Display some statistics about the project"
	@echo " test       Build and run regression tests (requires win2k.iso)"
	@echo " uninstall  Remove installed files"
	@echo

